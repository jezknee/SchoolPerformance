---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(readxl)
library(dplyr)
data_ks4_input <- read_excel("C:\\Users\\jezkn\\Local\\Data Science Projects\\School Data\\2023-2024\\Data\\england_ks4final.xlsx")
head(data_ks4_input, 5)
```

```{r}
data_ks4 <- data.frame(data_ks4_input[,c("RECTYPE","LEA","ESTAB","URN","SCHNAME","PCODE","PCON_CODE","NFTYPE","RELDENOM","ADMPOL_PT","EGENDER","FEEDER","PGPUP","ATT8SCR","P8PUP")])
head(data_ks4,50)
```
```{r}
# you need the comma afterwards, because it's [rows, columns]
data_ks4_2 <- data_ks4[!is.na(data_ks4$ATT8SCR) & data_ks4$ATT8SCR != "NE" & !is.na(data_ks4$SCHNAME), ]
head(data_ks4_2,50)
```

```{r}
lookup_lsoa_input <- read.csv("C:\\Users\\jezkn\\Local\\Data Science Projects\\School Data\\2023-2024\\Data\\PCD_OA21_LSOA21_MSOA21_LAD_MAY25_UK_LU.csv")
head(lookup_lsoa_input, 50)
```

```{r}
lookup_lsoa <- data.frame(lookup_lsoa_input[,c("pcds", "oa21cd", "lsoa21cd", "msoa21cd", "ladcd")])
names(lookup_lsoa)[names(lookup_lsoa) == 'pcds'] <- 'PCODE'
names(lookup_lsoa)[names(lookup_lsoa) == 'lsoa21cd'] <- 'LSOA_code'
names(lookup_lsoa)[names(lookup_lsoa) == 'msoa21cd'] <- 'MSOA_code'
head(lookup_lsoa, 5)
```


```{r}
joined_ks4_lookup <- data_ks4_2 |> left_join(lookup_lsoa, by = "PCODE")
head(joined_ks4_lookup, 50)
```

```{r}
parks_input <- read_excel("C:\\Users\\jezkn\\Local\\Data Science Projects\\School Data\\2023-2024\\Data\\LSOA access to parks and playing fields.xlsx")
#head(parks_input, 50)
#colnames(parks_input)
names(parks_input)[names(parks_input) == 'Average distance to nearest Park, Public Garden, or Playing Field (m)'] <- 'AVGPARKDIST'
names(parks_input)[names(parks_input) == 'Average combined size of  Parks, Public Gardens, or Playing Fields within 1,000 m radius (m2)'] <- 'SUMPARKSIZE'
names(parks_input)[names(parks_input) == "LSOA code"] <- 'LSOA_code'
parks <- data.frame(parks_input[,c("LSOA_code", "AVGPARKDIST", "SUMPARKSIZE")])
head(parks, 50)
```
```{r}
joined_ks4_2 <- joined_ks4_lookup |> left_join(parks, by = "LSOA_code")
head(joined_ks4_2, 50)
```
```{r}
qual_input <- read.csv("C:\\Users\\jezkn\\Local\\Data Science Projects\\School Data\\2023-2024\\Data\\Qualifications_Census.csv")
qual <- data.frame(qual_input)
colnames(qual) <- c("Date", "Geography", "MSOA_code", "All", "No_qual", "Level_1", "Level_2", "Apprenticeship", "Level_3", "Level_4", "Other_qual")
head(qual, 50)
```

```{r}
num_cols <- setdiff(names(qual)[sapply(qual, is.numeric)], "All")
qual[num_cols] <- lapply(qual[num_cols], function(x) x / qual$All)

# Now all numerical columns (except "All") are proportions
qual <- data.frame(qual[,c("MSOA_code","No_qual","Level_1","Level_2","Apprenticeship","Level_3","Level_4","Other_qual")])
head(qual)
```

```{r}
joined_ks4_3 <- joined_ks4_2 |> left_join(qual, by = "MSOA_code")
head(joined_ks4_3, 50)
```

